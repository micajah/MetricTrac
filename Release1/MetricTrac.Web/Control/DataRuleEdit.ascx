<%@ Control Language="C#" AutoEventWireup="true" CodeBehind="DataRuleEdit.ascx.cs" Inherits="MetricTrac.Control.DataRuleEdit" %>
<%@ Register Namespace="MetricTrac.MTControls" TagPrefix="mt" Assembly="MetricTrac.Web"%>
<%@ Register src="OrglocationMultipick.ascx" tagname="OrgLocationSelect" tagprefix="mts" %>
<%@ Register src="GCASelect.ascx" tagname="GCASelect" tagprefix="mts" %>
<div id="Div1" runat="server">
    <div runat="server"><script type="text/javascript">
        function DataCollectorRequestStart(ajaxPanel, eventArgs)
        {
            var eventTarget = eventArgs.get_eventTarget();
            if (eventTarget == '<%=mfDataCollector.Rows[mfDataCollector.Rows.Count-1].Cells[0].Controls[0].UniqueID %>')
            {
                eventArgs.set_enableAjax(false);
            }
        }

        function RuleTypeChange() {
            var rbGroup = document.getElementById('<%=mfDataCollector.FindControl("rbGroup").ClientID%>');
            var ddlGroup = document.getElementById('<%=mfDataCollector.FindControl("ddlGroup").ClientID%>');
            var ddlUser = document.getElementById('<%=mfDataCollector.FindControl("ddlUser").ClientID%>');
            if (rbGroup.checked) {
                ddlGroup.disabled = false;
                ddlUser.disabled = true;
            } else {
                ddlGroup.disabled = true;
                ddlUser.disabled = false;
            }
        }
    </script></div>
    <telerik:RadAjaxPanel runat="server" ID="rapDataCollector" LoadingPanelID="ralpDataCollector" EnableEmbeddedScripts="true" EnableAJAX="true" ClientEvents-OnRequestStart="DataCollectorRequestStart">
        <mits:MagicForm runat="server" ObjectName="Data Collector Rule" 
            ID="mfDataCollector" DefaultMode="Insert"
            AutoGenerateInsertButton="True" AutoGenerateDeleteButton="True" AutoGenerateEditButton="True"
            ShowCloseButtonSeparate="False" DataKeyNames="DataRuleID" 
            AutoGenerateRows="false" DataSourceID="ldsDataCollector" 
            OnAction="mfDataCollector_Action" 
            OnItemUpdated="mfDataCollector_ItemUpdated" 
            OnItemInserted="mfMDataCollector_ItemInserted" OnItemDeleted="mfDataCollector_ItemDeleted"
            OnItemInserting="mfDataCollector_ItemInserting" 
            OnItemUpdating="mfDataCollector_ItemUpdating" 
            ondatabound="mfDataCollector_DataBound">
            <Fields>
                <mits:TemplateField HeaderText="Org Location">                
                    <ItemTemplate>
                        <div style="padding-left:6px;">                            
                            <table cellpadding="0" cellspacing="0"><tr><td>
                            <mts:OrgLocationSelect ID="orgLocationSelect" runat="server" Width="300px" AutoPostBack="true" />
                            </td><td>
                            <ul style="color:Gray;"><li>Use &lt;Ctrl&gt;/&lt;Shift&gt; to select several Org Locations</li></ul>
                            </td></tr></table>
                        </div>
                    </ItemTemplate>
                </mits:TemplateField>
                <mits:TemplateField HeaderText="Group Category Aspect">
                    <ItemTemplate>
                        <div style="padding-left:6px;">
                        <mts:GCASelect ID="cASelect" runat="server" Width="300px" GCAID='<%#Bind("GroupCategoryAspectID")%>' AutoPostBack="true" />
                        </div>
                    </ItemTemplate>
                </mits:TemplateField>
                <mt:MTDropDownListField DataField="PerformanceIndicatorFormID" HeaderText="PI Form" DataTextField="Name" DataValueField="PerformanceIndicatorFormID" DataSourceId="dsPIForm" AddEmptyItem="true" Width="300" AutoPostBack="true" />
                <mt:MTDropDownListField DataField="PerformanceIndicatorID" HeaderText="PI" DataTextField="Name" DataValueField="PerformanceIndicatorID" DataSourceId="dsPI" AddEmptyItem="true" Width="300" AutoPostBack="true" />
                <mt:MTDropDownListField DataField="MetricID" HeaderText="Metric" DataTextField="Name" DataValueField="MetricID" DataSourceId="dsMetric" Width="300" AddEmptyItem="true"/>
                <mits:TemplateField>
                    <HeaderTemplate>
                        <%#DataRuleTypeID == 1 ? "Collector" : "Approver"%>
                    </HeaderTemplate>
                    <ItemTemplate>
                        <table>
                            <tr>
                                <td><asp:RadioButton runat="server" ID="rbGroup" Text="Group" GroupName="UserType" Checked='<%#Eval("UserID")==null%>' onclick="RuleTypeChange()" onkeydown="RuleTypeChange()"/></td>
                                <td><asp:DropDownList runat="server" ID="ddlGroup" DataSourceID="dsGroup" DataTextField="Name" DataValueField="GroupId" Width="300" Enabled='<%#Eval("UserID")==null%>'/></td>
                            </tr>
                            <tr>
                                <td><asp:RadioButton runat="server" ID="rbUser" Text="User" GroupName="UserType" Checked='<%#Eval("UserID")!=null%>' onclick="RuleTypeChange()" onkeydown="RuleTypeChange()"/></td>
                                <td><asp:DropDownList runat="server" ID="ddlUser" DataSourceID="dsUser" DataTextField="FullName" DataValueField="UserID" Width="300" Enabled='<%#Eval("UserID")!=null%>' /></td>
                            </tr>
                        </table>
                    </ItemTemplate>
                </mits:TemplateField>
                <mt:MTHtmlEditorField DataField="Description" HeaderText="Description"  ToolsFile="~/includes/ToolsFiles/BasicTools.xml" ControlStyle-Height="180px" />
            </Fields>
        </mits:MagicForm>
        
        <asp:LinqDataSource runat="server" ID="ldsDataCollector"
            ContextTypeName="MetricTrac.Bll.LinqMicajahDataContext" TableName="DataRule"
            AutoGenerateWhereClause="true" OnSelected="ldsDataCollector_Selected"
            EnableInsert="true" EnableDelete="true" EnableUpdate="true"
            oninserted="ldsDataCollector_Inserted" 
            onupdated="ldsDataCollector_Updated" onupdating="ldsDataCollector_Updating">
        </asp:LinqDataSource>
        
        <bll:BllDataSource runat="server" ID="dsUser" TableName="Mc_User" BllSelectMethod="List"/>
        <bll:BllDataSource runat="server" ID="dsPIForm" TableName="PerformanceIndicatorForm" OrderBy="Name"/>
        <bll:BllDataSource runat="server" ID="dsPI" TableName="PerformanceIndicator" OrderBy="Name"/>
        <bll:BllDataSource runat="server" ID="dsMetric" TableName="Metric" OrderBy="Name" OnSelecting="dsMetric_Selecting"/>
        <bll:BllDataSource runat="server" ID="dsGroup" TableName="Mc_Group" OrderBy="Name" />
        
        <telerik:RadAjaxLoadingPanel runat="server" ID="ralpDataCollector" Wrap="true" Transparency="33" BackColor="LightGray" ><table style="height:100%; width:100%">
        <tr><td valign="middle" align="center"><img alt="Loading ..." src="../images/loading6.gif" /></td></tr>
        </table></telerik:RadAjaxLoadingPanel>
    </telerik:RadAjaxPanel>
</div>